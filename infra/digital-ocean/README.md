# DigitalOcean

This guide shows how to deploy the app on DigitalOcean **manually** using the dashboard.

Recommended path for beginners: **DigitalOcean App Platform**.

## What you need first

1. A DigitalOcean account with billing enabled.
2. Access to this GitHub repository.
3. A `.env` file with production values.
4. Supabase already configured for your project (if not, follow [Supabase setup outside Vercel](../README.md#supabase-setup-outside-vercel)).

First, define base env vars from [Configure environment variables](../../README.md#2-configure-environment-variables-before-deploy).
Then fill `POSTGRES_URL`, `SUPABASE_URL`, and `SUPABASE_SERVICE_ROLE_KEY` with the values now available in your Supabase project.

You can validate your env locally before deploying:

```bash
ENV_FILE=.env ./infra/scripts/validate-runtime-env.sh --env-file "$ENV_FILE"
```

## 1) Create a DigitalOcean project (dashboard)

1. Open DigitalOcean dashboard.
2. Go to `Projects`.
3. Click `Create Project`.
4. Name it something like `kuest-production`.
5. Finish project creation.

## 2) Create an App Platform app from GitHub

1. In dashboard, open `Apps`.
2. Click `Create App`.
3. Choose `GitHub` as source.
4. Authorize DigitalOcean access to your repo (if first time).
5. Select repository: `<your-username>/prediction-market` (your fork).
6. Select branch `main` for production.
7. Continue.

## 3) Configure build settings

In the app component settings:

1. Component type: `Web Service`.
2. Source type: `Dockerfile`.
3. Dockerfile path: `infra/docker/Dockerfile`.
4. Build context: repository root (`.`).
5. HTTP port: `3000`.
6. Instance size: start with a small paid plan, then scale up after observing usage.
7. Region: choose the closest region to your users (for example `nyc` or `sfo`).

## 4) Configure environment variables (important)

In `Environment Variables`, add values from your production `.env`.

Mark secrets as encrypted in the UI (the lock icon). At minimum:

Plain/env values:

- `SITE_URL` (canonical public URL)
- `NEXT_PUBLIC_REOWN_APPKIT_PROJECT_ID`

Secret values:

- `SUPABASE_URL`
- `BETTER_AUTH_SECRET`
- `CRON_SECRET`
- `POSTGRES_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `ADMIN_WALLETS`
- `KUEST_ADDRESS`
- `KUEST_API_KEY`
- `KUEST_API_SECRET`
- `KUEST_PASSPHRASE`

## 5) Deploy the app

1. Click `Create Resources`.
2. Wait for build + deploy to finish.
3. Open the app URL generated by App Platform.
4. Verify key routes:
   - `/`

If deploy fails, open `Runtime Logs` and `Build Logs` in the dashboard and fix missing envs first.

## 6) Attach your custom domain

1. Open your app in App Platform.
2. Go to `Settings` > `Domains`.
3. Add your domain (for example `markets.example.com`).
4. Follow DNS instructions shown by DigitalOcean.
5. Wait for SSL certificate to be provisioned automatically.
6. Update `SITE_URL` to exactly match the final HTTPS domain.

## 7) Run DB migrations / cron setup

Supabase `pg_cron` setup remains managed by:

```bash
npm run db:push
```

Run this whenever migrations/cron definitions change, with production env loaded.

## 8) Rollback (quick)

1. Open App Platform app.
2. Go to `Deployments`.
3. Choose a previous healthy deployment.
4. Click `Rollback`.

## Optional: Terraform deploy for App Platform

If you prefer managing the App Platform app with Terraform:

```bash
export DIGITALOCEAN_TOKEN=<your-token>
cd infra/terraform/environments/production/digital-ocean
cp terraform.tfvars.example terraform.tfvars
terraform init
terraform plan
terraform apply
```

This target creates and manages the App Platform app, including environment variables and secrets.
