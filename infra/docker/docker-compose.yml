services:
  web:
    container_name: kuest-web
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
      args:
        NEXT_PUBLIC_REOWN_APPKIT_PROJECT_ID: ${NEXT_PUBLIC_REOWN_APPKIT_PROJECT_ID:?NEXT_PUBLIC_REOWN_APPKIT_PROJECT_ID is required}
    env_file:
      - ../../.env
    environment:
      NODE_ENV: production
      SITE_URL: ${SITE_URL:?SITE_URL is required}
    ports:
      - '3000:3000'
    restart: unless-stopped

  postgres:
    profiles: [local-postgres]
    container_name: kuest-postgres
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-kuest}
      POSTGRES_USER: ${POSTGRES_USER:-kuest}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-replace-me}
    volumes:
      - kuest-postgres-data:/var/lib/postgresql/data
    ports:
      - '127.0.0.1:5432:5432'
    restart: unless-stopped
    healthcheck:
      test: [CMD-SHELL, 'pg_isready -U ${POSTGRES_USER:-kuest} -d ${POSTGRES_DB:-kuest}']
      interval: 10s
      timeout: 5s
      retries: 6

volumes:
  kuest-postgres-data:
